 {% include 'docs/header.html' %}  <!-- Include the header -->
    <style>
         body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f0f0f0;
    }
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    header {
        background-color: #3498db;
        color: white;
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    nav ul {
        list-style-type: none;
        padding: 0;
        display: flex;
    }
    nav ul li {
        margin-right: 20px;
    }
    nav ul li a {
        color: white;
        text-decoration: none;
    }
    h1, h2 {
        color: #2c3e50;
    }
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    .dashboard-item {
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .dashboard-item h3 {
        margin-top: 0;
        color: #34495e;
    }
    .dashboard-item p {
        margin-bottom: 10px;
    }
    .status {
        font-weight: bold;
        color: #27ae60;
    }
    .status.pending {
        color: #f39c12;
    }
    .status.processing {
        color: #3498db;
    }
    .status.expired {
        color: #e74c3c;
    }
    .status.freezed {
        color: #9b59b6;
    }
    .cta-button {
        display: inline-block;
        background-color: #3498db;
        color: white;
        padding: 10px 15px;
        border-radius: 4px;
        text-decoration: none;
        margin-top: 10px;
        transition: background-color 0.3s ease;
    }
    .cta-button:hover {
        background-color: #2980b9;
    }
    .print-button {
        background-color: #2ecc71;
    }
    .print-button:hover {
        background-color: #27ae60;
    }
    .warning {
        background-color: #f39c12;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.9em;
        margin-top: 5px;
        display: inline-block;
    }
    .progress-bar {
        width: 100%;
        background-color: #e0e0e0;
        padding: 3px;
        border-radius: 3px;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, .2);
        margin-top: 10px;
    }
    .progress {
        display: block;
        height: 22px;
        background-color: #3498db;
        border-radius: 3px;
        transition: width 500ms ease-in-out;
    }
    </style>


<div class="container">
    <h4>Welcome, <span>{{ user.first_name }}</span></h4>
    {% if messages %}
        <div class="messages">
            {% for message in messages %}
                <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="dashboard-grid">
        <!-- National ID Card Section -->
        <div class="dashboard-item">
    <h3>National ID Card</h3>
        <p>Status:
            <span class="status {% if national_id_application %}{% if national_id_application.application.status == 'waiting' %}text-warning{% else %}text-success{% endif %}{% else %}text-muted{% endif %}">
                {% if national_id_application %}
                    {{ national_id_application.application.status|capfirst }}
                {% else %}
                    Not Applied
                {% endif %}
            </span>
        </p>
            {% if national_id_application_date %}
            <p>Application date:
                {{ national_id_application_date|date:"Y-m-d" }}
            </p>
            {% endif %}

            {% if national_id_application %}
                <a class="cta-button" data-toggle="modal" data-target="#applicationModal"
                        data-application-id="{{ national_id_application.application.id }}"
                        data-application-type="National ID Card">
                    View Application
                </a>
            {% else %}
                <a href="{% url 'apply_national_id' %}" class="cta-button">Apply Now</a>
            {% endif %}
        </div>

        <!-- Resident Permit Section -->
        <div class="dashboard-item">
            <h3>Resident Permit</h3>
            <p>Status:
                <span class="status {% if resident_permit_application %}{% if resident_permit_application.application.status == 'waiting' %}text-warning{% else %}text-success{% endif %}{% else %}text-muted{% endif %}">
                    {% if resident_permit_application %}
                        {{ resident_permit_application.application.status|capfirst }}
                    {% else %}
                        Not Applied
                    {% endif %}
                </span>
            </p>

            {% if resident_permit_application_date %}
            <p>Application date:
                {{ resident_permit_application_date|date:"Y-m-d" }}
            </p>
            {% endif %}

            {% if resident_permit_application %}
                <a class="cta-button" data-toggle="modal" data-target="#applicationModal"
                        data-application-id="{{ resident_permit_application.application.id }}"
                        data-application-type="Resident Permit">
                    View Application
                </a>
            {% else %}
                <a href="{% url 'apply_resident_permit' %}" class="cta-button">Apply Now</a>
            {% endif %}
        </div>

        <!-- Work Permit Section -->
        <div class="dashboard-item">
            <h3>Work Permit</h3>
            <p>Status:
                <span class="status {% if work_permit_application %}{% if work_permit_application.application.status == 'waiting' %}text-warning{% else %}text-success{% endif %}{% else %}text-muted{% endif %}">
                    {% if work_permit_application %}
                        {{ work_permit_application.application.status|capfirst }}
                    {% else %}
                        Not Applied
                    {% endif %}
                </span>
            </p>

            {% if work_permit_application_date %}
            <p>Application date:
                {{ work_permit_application_date|date:"Y-m-d" }}
            </p>
            {% endif %}

            {% if work_permit_application %}
                <a class="cta-button" data-toggle="modal" data-target="#applicationModal"
                        data-application-id="{{ work_permit_application.application.id }}"
                        data-application-type="Work Permit">
                    View Application
                </a>
            {% else %}
                <a href="{% url 'apply_work_permit' %}" class="cta-button">Apply Now</a>
            {% endif %}
        </div>
            <!-- New Driver's License item -->
            <div class="dashboard-item">
                <h3>Driver's License</h3>
                <p>Status: <span class="status expired" id="drivers-license-status">Expired</span></p>
                <p>Expiry Date: <span id="drivers-license-expiry">2023-05-31</span></p>
                <p>Points: <span id="drivers-license-points">8/12</span></p>
                <p>License Status: <span class="status" id="drivers-license-freeze-status">Active</span></p>
                <div class="warning">Your license has expired. Please apply for an extension.</div>
                <a href="#" class="cta-button">Apply for Extension</a>
                <a href="#" class="cta-button">View Point History</a>
            </div>

            <!-- Existing items continued -->
            <div class="dashboard-item">
                <h3>TIN Number</h3>
                <p>Status: <span class="status" id="tin-status">Approved</span></p>
                <p>TIN: <span id="tin-number">1234567890</span></p>
                <a href="#" class="cta-button print-button" onclick="printTIN()">Print TIN Certificate</a>
            </div>

            <div class="dashboard-item">
                <h3>Upcoming Appointments</h3>
                <p id="appointment-info">National ID Card Interview on 2023-06-15 at 10:00 AM</p>
                <p>Queue Number: <span id="queue-number">A123</span></p>
                <a href="#" class="cta-button">Manage Appointments</a>
                <a href="#" class="cta-button print-button" onclick="printAppointment()">Print Appointment</a>
            </div>

            <div class="dashboard-item">
                <h3>Upload Document</h3>
                {% if national_id_application %}
                <p>Status: <span class="status">{{ national_id_application.application.status }}</span></p>
                {% elif resident_permit_application %}
                <p>Status: <span class="status">{{ resident_permit_application.application.status }}</span></p>
                {% elif work_permit_application %}
                <p>Status: <span class="status">{{ work_permit_application.application.status }}</span></p>
                {% endif %}
                {% if national_id_application.application.status == 'waiting' %}
                    <a href="{% url 'upload_document' national_id_application.id %}" class="cta-button">Upload Document</a>
                {% elif resident_permit_application.application.status == 'waiting' %}
                    <a href="{% url 'upload_document' resident_permit_application.id %}" class="cta-button">Upload Document</a>
                {% elif work_permit_application.application.status == 'waiting' %}
                    <a href="{% url 'upload_document' work_permit_application.id %}" class="cta-button">Upload Document</a>
                {% else %}
                    <p>Document upload is not available at this stage.</p>
                {% endif %}
            </div>
        </div>
    </div>

 <!-- Modal for Viewing Application Details -->
<div class="modal fade" id="applicationModal" tabindex="-1" role="dialog" aria-labelledby="applicationModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="applicationModalLabel">Application Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="immigrationNote" class="alert alert-warning" style="display:none;">
                    <strong>Immigration Note:</strong> <span id="immigrationMessage"></span>
                </div>
                <div id="applicationDetails">
                    <!-- Dynamic content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
    <button type="button" class="btn btn-danger" id="cancelApplicationBtn" style="display:none;">Cancel Application</button>
    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
</div>
</div>
</div>
</div>

<script>
    let applicationId; // To store the application ID globally

    $(document).ready(function() {
        $('#applicationModal').on('show.bs.modal', function (event) {
            const button = $(event.relatedTarget);
            applicationId = button.data('application-id');  // Store application ID when the modal opens
            const applicationType = button.data('application-type');

            // AJAX request to fetch the application details
            $.ajax({
                url: "{% url 'fetch_application_details' %}",
                data: {
                    'application_id': applicationId,
                    'application_type': applicationType
                },
                success: function(response) {
                    $('#applicationDetails').html(response.html);

                    // Show immigration note if available
                    if (response.immigration_note) {
                        $('#immigrationNote').show();
                        $('#immigrationMessage').text(response.immigration_note);
                    } else {
                        $('#immigrationNote').hide();
                    }

                    // Show or hide cancel button
                    if (response.allow_cancel) {
                        $('#cancelApplicationBtn').show();
                    } else {
                        $('#cancelApplicationBtn').hide();
                    }
                }
            });
        });

        // Cancel Application button click event
        $('#cancelApplicationBtn').click(function() {
            if (applicationId) {
                // AJAX request to cancel the application
                $.ajax({
                    url: "{% url 'cancel_application' %}",
                    data: {
                        'application_id': applicationId
                    },
                    success: function(response) {
                        if (response.success) {
                            alert('Application successfully cancelled.');
                            $('#applicationModal').modal('hide');
                            location.reload();  // Reload the page to reflect the cancellation
                        } else {
                            alert(response.error);
                        }
                    },
                    error: function(xhr, status, error) {
                        alert('Error cancelling the application: ' + error);
                    }
                });
            }
        });
    });
</script>


<script>
        // Simulating user data
        const userData = {

            idCardStatus: "Document Verification",
            idCardApplicationDate: "2023-05-15",
            idCardProgress: 60,
            residentPermitStatus: "Pending Approval",
            residentPermitApplicationDate: "2023-05-20",
            residentPermitProgress: 80,
            workPermitStatus: "Processing",
            workPermitApplicationDate: "2023-06-01",
            workPermitProgress: 80,
            tinStatus: "Approved",
            tinNumber: "1234567890",
            driversLicense: {
                status: "Expired",
                expiryDate: "2023-05-31",
                points: 8,
                maxPoints: 12,
                freezeStatus: "Active"
            },
            appointment: {
                date: "2023-06-15",
                time: "10:00 AM",
                type: "National ID Card Interview",
                queueNumber: "A123"
            }
        };

        // Updating the dashboard with user data
        document.getElementById('user-name').textContent = userData.name;
        document.getElementById('id-card-status').textContent = userData.idCardStatus;
        document.getElementById('id-card-application-date').textContent = userData.idCardApplicationDate;
        document.getElementById('id-card-progress').style.width = `${userData.idCardProgress}%`;
        document.getElementById('resident-permit-status').textContent = userData.residentPermitStatus;
        document.getElementById('resident-permit-application-date').textContent = userData.residentPermitApplicationDate;
        document.getElementById('resident-permit-progress').style.width = `${userData.residentPermitProgress}%`;
        document.getElementById('work-permit-status').textContent = userData.workPermitStatus;
        document.getElementById('work-permit-application-date').textContent = userData.workPermitApplicationDate;
        document.getElementById('work-permit-progress').style.width = `${userData.workPermitProgress}%`;
        document.getElementById('tin-status').textContent = userData.tinStatus;
        document.getElementById('tin-number').textContent = userData.tinNumber;

        // Update Driver's License information
        document.getElementById('drivers-license-status').textContent = userData.driversLicense.status;
        document.getElementById('drivers-license-expiry').textContent = userData.driversLicense.expiryDate;
        document.getElementById('drivers-license-points').textContent = `${userData.driversLicense.points}/${userData.driversLicense.maxPoints}`;
        document.getElementById('drivers-license-freeze-status').textContent = userData.driversLicense.freezeStatus;

        if (userData.appointment) {
            document.getElementById('appointment-info').textContent =
                `${userData.appointment.type} on ${userData.appointment.date} at ${userData.appointment.time}`;
            document.getElementById('queue-number').textContent = userData.appointment.queueNumber;
        }

        // Function to print appointment details
        function printAppointment() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Appointment Details</title>
                    <style>
                        body { font-family: Arial, sans-serif; line-height: 1.6; }
                        h1 { color: #3498db; }
                        .appointment-details { border: 1px solid #ccc; padding: 20px; margin-top: 20px; }
                    </style>
                </head>
                <body>
                    <h1>National Document Portal - Appointment Details</h1>
                    <div class="appointment-details">
                        <h2>${userData.appointment.type}</h2>
                        <p><strong>Date:</strong> ${userData.appointment.date}</p>
                        <p><strong>Time:</strong> ${userData.appointment.time}</p>
                        <p><strong>Queue Number:</strong> ${userData.appointment.queueNumber}</p>
                        <p><strong>Applicant:</strong> ${userData.name}</p>
                    </div>
                    <p>Please bring this appointment slip and all required documents to your interview.</p>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Function to print TIN certificate
        function printTIN() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>TIN Certificate</title>
                    <style>
                        body { font-family: Arial, sans-serif; line-height: 1.6; }
                        h1 { color: #3498db; }
                        .tin-details { border: 2px solid #3498db; padding: 20px; margin-top: 20px; text-align: center; }
                    </style>
                </head>
                <body>
                    <h1>National Document Portal - TIN Certificate</h1>
                    <div class="tin-details">
                        <h2>Tax Identification Number (TIN)</h2>
                        <h3>${userData.tinNumber}</h3>
                        <p><strong>Name:</strong> ${userData.name}</p>
                        <p><strong>Issue Date:</strong> ${new Date().toLocaleDateString()}</p>
                    </div>
                    <p>This document serves as an official certificate of your Tax Identification Number.</p>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
    </script>

      {% include 'docs/footer.html' %}  <!-- Include the footer -->
