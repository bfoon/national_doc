 {% extends 'docs/header.html' %}
 <!-- Include the header -->
 {% block content %}
    <style>

    h1, h2 {
        color: #2c3e50;
    }
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    .dashboard-item {
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .dashboard-item h3 {
        margin-top: 0;
        color: #34495e;
    }
    .dashboard-item p {
        margin-bottom: 10px;
    }
    .status {
        font-weight: bold;
        color: #27ae60;
    }
    .status.pending {
        color: #f39c12;
    }
    .status.processing {
        color: #3498db;
    }
    .status.expired {
        color: #e74c3c;
    }
    .status.freezed {
        color: #9b59b6;
    }
    .cta-button {
        display: inline-block;
        background-color: #3498db;
        color: white;
        padding: 10px 15px;
        border-radius: 4px;
        text-decoration: none;
        margin-top: 10px;
        transition: background-color 0.3s ease;
    }
    .cta-button:hover {
        background-color: #2980b9;
    }
    .print-button {
        background-color: #2ecc71;
    }
    .print-button:hover {
        background-color: #27ae60;
    }
    .warning {
        background-color: #f39c12;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.9em;
        margin-top: 5px;
        display: inline-block;
    }
    .progress-bar {
        width: 100%;
        background-color: #e0e0e0;
        padding: 3px;
        border-radius: 3px;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, .2);
        margin-top: 10px;
    }
    .progress {
        display: block;
        height: 22px;
        background-color: #3498db;
        border-radius: 3px;
        transition: width 500ms ease-in-out;
    }
    </style>


<div class="container">
    <h4>Welcome, <span>{{ user.first_name }}</span></h4>
    {% if messages %}
        <div class="messages">
            {% for message in messages %}
                <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="dashboard-grid">
        <!-- National ID Card Section -->
        <div class="dashboard-item">
    <h3>National ID Card</h3>
        <p>Status:
            <span class="status {% if national_id_application %}{% if national_id_application.application.status == 'waiting' %}text-warning{% else %}text-success{% endif %}{% else %}text-muted{% endif %}">
                {% if national_id_application %}
                    {{ national_id_application.application.status|capfirst }}
                {% else %}
                    Not Applied
                {% endif %}
            </span>
        </p>
            {% if national_id_application_date %}
            <p>Application date:
                {{ national_id_application_date|date:"Y-m-d" }}
            </p>
            {% endif %}

            {% if national_id_application.application and national_id_application.application.status != "canceled" %}
                <a class="cta-button" data-toggle="modal" data-target="#applicationModal"
                        data-application-id="{{ national_id_application.application.id }}"
                        data-application-type="National ID Card">
                    View Application
                </a>
            {% else %}
                <a href="{% url 'apply_national_id' %}" class="cta-button">Apply Now</a>
            {% endif %}
        </div>

        <!-- Resident Permit Section -->
        <div class="dashboard-item">
            <h3>Resident Permit</h3>
            <p>Status:
                <span class="status {% if resident_permit_application %}{% if resident_permit_application.application.status == 'waiting' %}text-warning{% else %}text-success{% endif %}{% else %}text-muted{% endif %}">
                    {% if resident_permit_application %}
                        {{ resident_permit_application.application.status|capfirst }}
                    {% else %}
                        Not Applied
                    {% endif %}
                </span>
            </p>

            {% if resident_permit_application_date %}
            <p>Application date:
                {{ resident_permit_application_date|date:"Y-m-d" }}
            </p>
            {% endif %}

            {% if resident_permit_application.application and resident_permit_application.application.status != "canceled" %}
                <a class="cta-button" data-toggle="modal" data-target="#applicationModal"
                        data-application-id="{{ resident_permit_application.application.id }}"
                        data-application-type="Resident Permit">
                    View Application
                </a>
            {% else %}
                <a href="{% url 'apply_resident_permit' %}" class="cta-button">Apply Now</a>
            {% endif %}
        </div>

        <!-- Work Permit Section -->
        <div class="dashboard-item">
            <h3>Work Permit</h3>
            <p>Status:
                <span class="status {% if work_permit_application %}{% if work_permit_application.application.status == 'waiting' %}text-warning{% else %}text-success{% endif %}{% else %}text-muted{% endif %}">
                    {% if work_permit_application %}
                        {{ work_permit_application.application.status|capfirst }}
                    {% else %}
                        Not Applied
                    {% endif %}
                </span>
            </p>

            {% if work_permit_application_date %}
            <p>Application date:
                {{ work_permit_application_date|date:"Y-m-d" }}
            </p>
            {% endif %}

            {% if work_permit_application.application and work_permit_application.application.status != "canceled" %}
                <a class="cta-button" data-toggle="modal" data-target="#applicationModal"
                        data-application-id="{{ work_permit_application.application.id }}"
                        data-application-type="Work Permit">
                    View Application
                </a>
            {% else %}
                <a href="{% url 'apply_work_permit' %}" class="cta-button">Apply Now</a>
            {% endif %}
        </div>
            <!-- New Driver's License item -->
            <div class="dashboard-item">
                <h3>Driver's License</h3>
                <p>Status: <span class="status expired" id="drivers-license-status">Expired</span></p>
                <p>Expiry Date: <span id="drivers-license-expiry">2023-05-31</span></p>
                <p>Points: <span id="drivers-license-points">8/12</span></p>
                <p>License Status: <span class="status" id="drivers-license-freeze-status">Active</span></p>
                <div class="warning">Your license has expired. Please apply for an extension.</div>
                <a href="#" class="cta-button">Apply for Extension</a>
                <a href="#" class="cta-button">View Point History</a>
            </div>

            <!-- Existing items continued -->
            <div class="dashboard-item">
                <h3>TIN Number</h3>
                <p>Status: <span class="status" id="tin-status">Approved</span></p>
                <p>TIN: <span id="tin-number">1234567890</span></p>
                <a href="#" class="cta-button print-button" onclick="printTIN()">Print TIN Certificate</a>
            </div>

            <div class="dashboard-item">
                <h3>Upcoming Appointments</h3>
                {% if national_id_application.application.status == 'interview' %}
                <p id="appointment-info">National ID Card Interview on
                    {{ national_id_application.application.interview_slot.date_time|date:"Y-m-d H:i"}}</p>
                <p>Queue Number: <span id="queue-number">{{ national_id_application.application.interview_queue_number }}</span></p>
                <a href="#" class="cta-button">Manage Appointments</a>
                <a href="#" class="cta-button print-button" onclick="printAppointment('nationalId')">Print National ID Appointment</a>
                {% elif resident_permit_application.application.status == 'interview' %}
                <p id="appointment-info">National ID Card Interview on
                    {{ resident_permit_application.application.interview_slot.date_time|date:"Y-m-d H:i"}}</p>
                <p>Queue Number: <span id="queue-number">{{ resident_permit_application.application.interview_queue_number }}</span></p>
                <a href="#" class="cta-button">Manage Appointments</a>
                <a href="#" class="cta-button print-button" onclick="printAppointment('residentPermit')">Print Resident Permit Appointment</a>
                {% elif work_permit_application.application.status == 'interview' %}
                <p id="appointment-info">National ID Card Interview on
                    {{ work_permit_application.application.interview_slot.date_time|date:"Y-m-d H:i"}}</p>
                <p>Queue Number: <span id="queue-number">{{ work_permit_application.application.interview_queue_number }}</span></p>
                <a href="#" class="cta-button">Manage Appointments</a>
                <a href="#" class="cta-button print-button" onclick="printAppointment('workPermit')">Print Work Permit Appointment</a>


                {% endif %}
            </div>

            <div class="dashboard-item">
                <h3>Upload Document</h3>
                {% if national_id_application.application.status == 'waiting' %}
                <p>Status: <span class="status">{{ national_id_application.application.status }}</span></p>
                {% elif resident_permit_application.application.status == 'waiting' %}
                <p>Status: <span class="status">{{ resident_permit_application.application.status }}</span></p>
                {% elif work_permit_application.application.status == 'waiting' %}
                <p>Status: <span class="status">{{ work_permit_application.application.status }}</span></p>
                {% endif %}
                {% if national_id_application.application.status == 'waiting' %}
                    <a href="{% url 'upload_document' national_id_application.application.id %}" class="cta-button">Upload Document</a>
                <button class="btn btn-info" data-toggle="modal" data-target="#notesModal">
                <i class="fas fa-info-circle"></i> View Notes
                </button>
                {% elif resident_permit_application.application.status == 'waiting' %}
                    <a href="{% url 'upload_document' resident_permit_application.application.id %}" class="cta-button">Upload Document</a>
                <button class="btn btn-info" data-toggle="modal" data-target="#notesModal">
                <i class="fas fa-info-circle"></i> View Notes
                </button>
                {% elif work_permit_application.application.status == 'waiting' %}
                    <a href="{% url 'upload_document' work_permit_application.application.id %}" class="cta-button">Upload Document</a>
                <button class="btn btn-info" data-toggle="modal" data-target="#notesModal">
                <i class="fas fa-info-circle"></i> View Notes
                </button>
                {% else %}
                    <p>Document upload is not available at this stage.</p>
                {% endif %}
            </div>
        </div>
    </div>

 <!-- Modal for Viewing Application Details -->
<div class="modal fade" id="applicationModal" tabindex="-1" role="dialog" aria-labelledby="applicationModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="applicationModalLabel">Application Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="immigrationNote" class="alert alert-warning" style="display:none;">
                    <strong>Immigration Note:</strong> <span id="immigrationMessage"></span>
                </div>
                <div id="applicationDetails">
                    <!-- Dynamic content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
    <button type="button" class="btn btn-danger" id="cancelApplicationBtn" style="display:none;">Cancel Application</button>
    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
</div>
</div>
</div>
</div>


 <!-- Modal for Notes -->
<div class="modal fade" id="notesModal" tabindex="-1" role="dialog" aria-labelledby="notesModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="notesModalLabel">Notes</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <ul class="list-group">
                     {% if national_id_application.application.notes %}
                            <li class="list-group-item">
                                <strong>{{ national_id_application.application.notes.first.user.get_full_name }}
                                    ({{ national_id_application.application.notes.first.created_at|date:"Y-m-d H:i" }}):</strong>
                                <p>{{ national_id_application.application.notes.first.message }}</p>
                            </li>
                    {% elif resident_permit_application.application.notes %}
                            <li class="list-group-item">
                                <strong>{{ resident_permit_application.application.notes.first.user.get_full_name }}
                                    ({{ resident_permit_application.application.notes.first.created_at|date:"Y-m-d H:i" }}):</strong>
                                <p>{{ resident_permit_application.application.notes.first.message }}</p>
                            </li>
                     {% elif work_permit_application.application.notes %}
                            <li class="list-group-item">
                                <strong>{{ work_permit_application.application.notes.first.user.get_full_name }}
                                    ({{ work_permit_application.application.notes.first.created_at|date:"Y-m-d H:i" }}):</strong>
                                <p>{{ work_permit_application.application.notes.first.message }}</p>
                            </li>
                    {% else %}
                        <li class="list-group-item">No notes available.</li>
                    {% endif %}
                </ul>
            </div>
            </div>
            </div>
            </div>



<script>
    let applicationId; // To store the application ID globally

    $(document).ready(function() {
        $('#applicationModal').on('show.bs.modal', function (event) {
            const button = $(event.relatedTarget);
            applicationId = button.data('application-id');  // Store application ID when the modal opens
            const applicationType = button.data('application-type');

            // AJAX request to fetch the application details
            $.ajax({
                url: "{% url 'fetch_application_details' %}",
                data: {
                    'application_id': applicationId,
                    'application_type': applicationType
                },
                success: function(response) {
                    $('#applicationDetails').html(response.html);

                    // Show immigration note if available
                    if (response.immigration_note) {
                        $('#immigrationNote').show();
                        $('#immigrationMessage').text(response.immigration_note);
                    } else {
                        $('#immigrationNote').hide();
                    }

                    // Show or hide cancel button
                    if (response.allow_cancel) {
                        $('#cancelApplicationBtn').show();
                    } else {
                        $('#cancelApplicationBtn').hide();
                    }
                }
            });
        });

        // Cancel Application button click event
        $('#cancelApplicationBtn').click(function() {
            if (applicationId) {
                // AJAX request to cancel the application
                $.ajax({
                    url: "{% url 'cancel_application' %}",
                    data: {
                        'application_id': applicationId
                    },
                    success: function(response) {
                        if (response.success) {
                            alert('Application successfully cancelled.');
                            $('#applicationModal').modal('hide');
                            location.reload();  // Reload the page to reflect the cancellation
                        } else {
                            alert(response.error);
                        }
                    },
                    error: function(xhr, status, error) {
                        alert('Error cancelling the application: ' + error);
                    }
                });
            }
        });
    });
</script>


<script>
    const userData = {
        nationalId: {
            appointment: {
                date: "{{ national_id_application.application.interview_slot.date_time|date:'Y-m-d' }}",
                time: "{{ national_id_application.application.interview_slot.date_time|time:'H:i' }}",
                type: "National ID Card Interview",
                name: "{{ national_id_application.full_name }}",
                queueNumber: "{{ national_id_application.application.interview_queue_number }}"
            }
        },
        residentPermit: {
            appointment: {
                date: "{{ resident_permit_application.application.interview_slot.date_time|date:'Y-m-d' }}",
                time: "{{ resident_permit_application.application.interview_slot.date_time|time:'H:i' }}",
                type: "Resident Permit Interview",
                name: "{{ resident_permit_application.full_name }}",
                queueNumber: "{{ resident_permit_application.application.interview_queue_number }}"
            }
        },
        workPermit: {
            appointment: {
                date: "{{ work_permit_application.application.interview_slot.date_time|date:'Y-m-d' }}",
                time: "{{ work_permit_application.application.interview_slot.date_time|time:'H:i' }}",
                type: "Work Permit Interview",
                name: "{{ work_permit_application.full_name }}",
                queueNumber: "{{ work_permit_application.application.interview_queue_number }}"
            }
        },
        // Add any other services as needed...
    };

    // Function to print appointment details
    function printAppointment(applicationType) {
        const appointment = userData[applicationType].appointment; // Get the specific appointment data

        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
            <head>
                <title>Appointment Details</title>
                <style>
                    body { font-family: Arial, sans-serif; line-height: 1.6; }
                    h1 { color: #3498db; }
                    .appointment-details { border: 1px solid #ccc; padding: 20px; margin-top: 20px; }
                </style>
            </head>
            <body>
                <h1>National Document Portal - Appointment Details</h1>
                <div class="appointment-details">
                    <h2>${appointment.type}</h2>
                    <p><strong>Date:</strong> ${appointment.date}</p>
                    <p><strong>Time:</strong> ${appointment.time}</p>
                    <p><strong>Queue Number:</strong> ${appointment.queueNumber}</p>
                    <p><strong>Applicant:</strong> ${appointment.name}</p>
                </div>
                <p>Please bring this appointment slip and all required documents to your interview.</p>
            </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.print();
    }
</script>


      {% endblock %}
