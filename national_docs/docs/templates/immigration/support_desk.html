<!-- templates/immigration/support_desk.html -->
{% extends 'docs/header.html' %}
{% block content %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/support_desk.css' %}">

<div class="container my-5">
    <!-- Display Messages -->
    {% if messages %}
        <div class="messages mb-4">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show shadow-sm border-0" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-info-circle me-2"></i>
                        <div>{{ message }}</div>
                        <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Modern Header Section -->
    <div class="row mb-4 align-items-center">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0 bg-transparent">
                    <li class="breadcrumb-item">
                        <a href="{% url 'immigration_dashboard' %}" class="text-decoration-none">
                            <i class="fas fa-home"></i> Dashboard
                        </a>
                    </li>
                    <li class="breadcrumb-item active">Support Desk</li>
                </ol>
            </nav>
        </div>

    <!-- Enhanced Statistics Cards -->
    <div class="row g-4 mb-4">
        <!-- Open Applications Card -->
        <div class="col-md-3 col-sm-6">
            <div class="card border-0 shadow-sm h-100 bg-gradient">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 bg-primary bg-opacity-10 p-3 rounded-circle">
                            <i class="fas fa-folder-open text-primary fa-2x"></i>
                        </div>
                        <div class="ms-3">
                            <h3 class="mb-0 fw-bold text-primary" id="open-applications">0</h3>
                            <p class="text-muted mb-0">Open Applications</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Closed Applications Card -->
        <div class="col-md-3 col-sm-6">
            <div class="card border-0 shadow-sm h-100 bg-gradient">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 bg-success bg-opacity-10 p-3 rounded-circle">
                            <i class="fas fa-check-circle text-success fa-2x"></i>
                        </div>
                        <div class="ms-3">
                            <h3 class="mb-0 fw-bold text-success" id="closed-applications">0</h3>
                            <p class="text-muted mb-0">Closed Applications</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Open Chats Card -->
        <div class="col-md-3 col-sm-6">
            <div class="card border-0 shadow-sm h-100 bg-gradient">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 bg-danger bg-opacity-10 p-3 rounded-circle">
                            <i class="fas fa-comments text-danger fa-2x"></i>
                        </div>
                        <div class="ms-3">
                            <h3 class="mb-0 fw-bold text-danger" id="open-chats">0</h3>
                            <p class="text-muted mb-0">Open Chats</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Closed Chats Card -->
        <div class="col-md-3 col-sm-6">
            <div class="card border-0 shadow-sm h-100 bg-gradient">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 bg-secondary bg-opacity-10 p-3 rounded-circle">
                            <i class="fas fa-check-double text-secondary fa-2x"></i>
                        </div>
                        <div class="ms-3">
                            <h3 class="mb-0 fw-bold text-secondary" id="closed-chats">0</h3>
                            <p class="text-muted mb-0">Closed Chats</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- FAQ Section -->
<div class="card mb-4 border-0 shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center bg-gradient bg-info text-white py-3">
        <div class="d-flex align-items-center">
            <i class="fas fa-question-circle fa-lg me-2"></i>
            <h5 class="mb-0">Frequently Asked Questions</h5>
        </div>
        <button class="btn btn-light btn-sm d-flex align-items-center gap-2 shadow-sm"
                data-bs-toggle="modal"
                data-bs-target="#addFAQModal">
            <i class="fas fa-plus-circle"></i>
            <span>Add FAQ</span>
        </button>
    </div>

    <div class="card-body">
        <!-- Enhanced Search FAQ with icon -->
        <div class="mb-4">
            <div class="input-group">
                <span class="input-group-text bg-light border-end-0">
                    <i class="fas fa-search text-muted"></i>
                </span>
                <input type="text"
                       class="form-control border-start-0 ps-0"
                       id="searchFAQ"
                       placeholder="Search FAQs..."
                       aria-label="Search FAQs">
            </div>
        </div>

        <!-- FAQ Accordion List -->
        <div class="accordion accordion-flush" id="faqAccordion">
            {% for faq in faqs %}
                <div class="accordion-item border mb-3 rounded-3 shadow-sm">
                    <h2 class="accordion-header" id="heading-{{ faq.id }}">
                        <button class="accordion-button collapsed rounded-3 bg-light"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#collapse-{{ faq.id }}"
                                aria-expanded="false"
                                aria-controls="collapse-{{ faq.id }}">
                            <div class="d-flex align-items-center w-100">
                                <span class="badge bg-info text-white me-3">Q</span>
                                <span class="fw-semibold">{{ faq.question }}</span>
                            </div>
                        </button>
                    </h2>
                    <div id="collapse-{{ faq.id }}"
                         class="accordion-collapse collapse"
                         aria-labelledby="heading-{{ faq.id }}"
                         data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            <div class="row">
                                <div class="col">
                                    <div class="bg-light p-3 rounded-3 position-relative">
                                        <span class="badge bg-success position-absolute top-0 start-0 mt-2 ms-2">A</span>
                                        <div class="ms-4">{{ faq.answer }}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="d-flex justify-content-end mt-3 gap-2">
                                <button class="btn btn-outline-warning btn-sm d-flex align-items-center gap-2 edit-faq-btn"
                                        data-bs-toggle="modal"
                                        data-bs-target="#updateFAQModal"
                                        data-faq-id="{{ faq.id }}"
                                        data-question="{{ faq.question }}"
                                        data-answer="{{ faq.answer }}">
                                    <i class="fas fa-edit"></i>
                                    <span>Edit</span>
                                </button>
                                <a href="#"
                                   class="btn btn-outline-danger btn-sm d-flex align-items-center gap-2"
                                   onclick="return confirm('Are you sure you want to delete this FAQ?');">
                                    <i class="fas fa-trash-alt"></i>
                                    <span>Delete</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="text-center py-5">
                    <i class="fas fa-question-circle fa-3x text-muted mb-3"></i>
                    <p class="text-muted mb-0">No FAQs available.</p>
                </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Chat Messages Section -->
<div class="card border-0 shadow-sm mb-5">
    <div class="card-header bg-gradient bg-success text-white py-3 d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <i class="fas fa-comments fa-lg me-2"></i>
            <h5 class="mb-0">Chat Messages</h5>
        </div>
        <div class="d-flex gap-2">
            <div class="input-group input-group-sm">
                <span class="input-group-text bg-white border-end-0">
                    <i class="fas fa-search text-muted"></i>
                </span>
                <input type="text" class="form-control border-start-0 ps-0" placeholder="Search messages...">
            </div>
            <select class="form-select form-select-sm" style="width: auto;">
                <option value="all">All Messages</option>
                <option value="unread">Unread</option>
                <option value="urgent">Urgent</option>
            </select>
        </div>
    </div>

    <div class="card-body p-0">
        <div class="chat-container" style="max-height: 600px; overflow-y: auto;">
            {% for chat in chats %}
                <div class="chat-thread p-4 border-bottom" id="chat-{{ chat.id }}">
                    <!-- Main Message -->
                    <div class="d-flex gap-3">
                        <!-- User Avatar -->
                        <div class="flex-shrink-0">
                            <div class="avatar-circle bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                                <i class="fas fa-user text-primary"></i>
                            </div>
                        </div>

                        <!-- Message Content -->
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="mb-1">
                                        <a href="#" class="text-decoration-none sender-details-link fw-bold"
                                           data-bs-toggle="modal"
                                           data-bs-target="#senderDetailsModal"
                                           data-sender-id="{{ chat.sender.id }}"
                                           data-chat-id="{{ chat.id }}"
                                           data-sender-name="{{ chat.sender.get_full_name }}">
                                            {{ chat.sender.get_full_name }}
                                        </a>
                                        <span class="badge bg-info ms-2 fs-xs">New User</span>
                                        {% if chat.has_note %}
                                            <span class="ms-2 align-middle">
                                                <i class="fas fa-sticky-note text-success"></i>
                                            </span>
                                        {% endif %}
                                    </h6>
                                    <div class="text-muted fs-sm">
                                        <i class="fas fa-clock me-1"></i>
                                        {{ chat.timestamp|date:"Y-m-d H:i" }}
                                    </div>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-primary btn-sm d-flex align-items-center gap-1 respond-btn"
                                            data-bs-toggle="modal"
                                            data-bs-target="#respondChatModal"
                                            data-chat-id="{{ chat.id }}"
                                            data-sender-name="{{ chat.sender.get_full_name }}">
                                        <i class="fas fa-reply"></i>
                                        <span>Reply</span>
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm d-flex align-items-center gap-1 close-btn"
                                            data-chat-id="{{ chat.id }}">
                                        <i class="fas fa-times"></i>
                                        <span>Close</span>
                                    </button>
                                </div>
                            </div>
                            <div class="message-content p-3 bg-light rounded-3">
                                {{ chat.message }}
                            </div>

                          <!-- Replies Section -->
                        {% if chat.replies.exists %}
                            <div class="replies-section mt-3 ms-4 border-start border-success border-3" style="max-height: 300px; overflow-y: auto;">
                                {% for reply in chat.replies.all %}
                                    <div class="reply-item ms-3 mb-3">
                                        <div class="d-flex gap-2">
                                            <!-- Reply Avatar -->
                                            <div class="flex-shrink-0">
                                                <div class="avatar-circle bg-success bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                                    <i class="fas fa-headset text-success"></i>
                                                </div>
                                            </div>
                                            <!-- Reply Content -->
                                            <div class="flex-grow-1">
                                                <div class="d-flex justify-content-between align-items-center mb-1">
                                                    <h6 class="mb-0 fw-semibold">
                                                        {{ reply.sender.get_full_name }}
                                                        <span class="badge
                                                            {% if reply.response_type == 'general' %}text-primary{% elif reply.response_type == 'technical' %}text-warning{% elif reply.response_type == 'inquiry' %}text-info{% elif reply.response_type == 'urgent' %}text-danger{% endif %}
                                                            fw-semibold">
                                                            {{ reply.get_response_type_display|title }}
                                                        </span>
                                                    </h6>

                                                    <small class="text-muted">{{ reply.timestamp|date:"Y-m-d H:i" }}</small>
                                                </div>
                                                <div class="message-content p-2 bg-white rounded-3 border">
                                                    {{ reply.message }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}

                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="text-center py-5">
                    <div class="mb-3">
                        <i class="fas fa-comments fa-3x text-muted"></i>
                    </div>
                    <h6 class="text-muted">No chat messages available</h6>
                    <p class="text-muted small mb-0">New messages will appear here</p>
                </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Call Notes Section -->
<div class="card border-0 shadow-sm">
    <div class="card-header bg-gradient bg-warning text-white py-3">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <i class="fas fa-phone-alt fa-lg me-2"></i>
                <h5 class="mb-0">Call Notes</h5>
                <span class="badge bg-light text-warning ms-2">{{ incomplete_notes|length }} Open Notes</span>
            </div>
            <div class="d-flex gap-2">
                <div class="btn-group">
                    <button class="btn btn-light btn-sm active">All</button>
                    <button class="btn btn-light btn-sm">Active</button>
                    <button class="btn btn-light btn-sm">Completed</button>
                </div>
                <button class="btn btn-light btn-sm d-flex align-items-center gap-2"
                        data-bs-toggle="modal"
                        data-bs-target="#addCallNoteModal">
                    <i class="fas fa-plus-circle"></i>
                    <span>Add Note</span>
                </button>
            </div>
        </div>
    </div>

    <div class="card-body">
        <!-- Enhanced Search Bar -->
        <div class="mb-4">
            <div class="input-group">
                <span class="input-group-text bg-light border-end-0">
                    <i class="fas fa-search text-muted"></i>
                </span>
                <input type="text"
                       id="searchCallNotes"
                       class="form-control border-start-0 ps-0"
                       placeholder="Search call notes..."
                       aria-label="Search call notes">
                <button class="btn btn-outline-secondary" type="button">
                    <i class="fas fa-filter"></i>
                </button>
            </div>
        </div>

        <!-- Call Notes Timeline -->
        <div id="callNotesContainer" class="timeline-container" style="max-height: 600px; overflow-y: auto;">
            {% for note in call_notes %}
                <div class="timeline-item mb-4 {% if note.completed %}completed{% endif %}" id="note-{{ note.id }}">
                    <div class="timeline-badge {% if note.completed %}bg-success{% else %}bg-warning{% endif %}">
                        <i class="fas {% if note.completed %}fa-check{% else %}fa-phone{% endif %}"></i>
                    </div>
                    <div class="timeline-content">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <!-- Note Header -->
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-circle bg-light rounded-circle d-flex align-items-center justify-content-center me-2"
                                             style="width: 40px; height: 40px;">
                                            <i class="fas fa-user text-warning"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-0 font-weight-bold" style="text-transform: uppercase;">{{ note.customer }}</h6>
                                            <small class="text-muted">
                                                <i class="fas fa-clock me-1"></i>
                                                {{ note.created_at|date:"Y-m-d H:i" }}
                                            </small>
                                        </div>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm {% if note.completed %}btn-success disabled{% else %}btn-outline-success{% endif %} close-note-btn"
                                                data-note-id="{{ note.id }}"
                                                {% if not note.completed %}
                                                title="Mark as completed"
                                                {% endif %}>
                                            <i class="fas {% if note.completed %}fa-check-circle{% else %}fa-check{% endif %}"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Note Content -->
                                <div class="note-content {% if note.completed %}text-muted{% endif %}">
                                    <div class="p-3 bg-light rounded-3 {% if note.completed %}bg-opacity-50{% endif %}">
                                        <strong>Call Type:</strong> {{ note.get_call_type_display }} <br>
                                        <strong>Priority:</strong>
                                        <span class="badge {% if note.priority == 'high' %}bg-danger{% elif note.priority == 'medium' %}bg-warning{% else %}bg-success{% endif %}">
                                            {{ note.priority|capfirst }}
                                        </span><br>
                                        {% if note.followup %}
                                            <i class="fas fa-exclamation-circle text-warning"></i> Follow-up Required
                                        {% endif %}
                                    </div>
                                   <div class="mt-3 p-3 bg-light border rounded-3 shadow-sm">
                                        <p class="mb-0 text-dark" style="font-style: italic; font-size: 1.1rem;">
                                            {{ note.note }}
                                        </p>
                                    </div>

                                    {% if note.tags %}
                                    <div class="mt-2">
                                        {% for tag in note.tags %}
                                            <span class="badge bg-info bg-opacity-10 text-info me-1">{{ tag }}</span>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="text-center py-5">
                    <div class="mb-3">
                        <i class="fas fa-sticky-note fa-3x text-muted"></i>
                    </div>
                    <h6 class="text-muted">No call notes available</h6>
                    <p class="text-muted small mb-0">Click 'Add Note' to create your first note</p>
                </div>
            {% endfor %}
        </div>
    </div>
</div>


<!-- Add FAQ Modal -->
<div class="modal fade" id="addFAQModal" tabindex="-1" role="dialog" aria-labelledby="addFAQModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-gradient bg-info text-white align-items-center">
                <div class="d-flex align-items-center">
                    <i class="fas fa-question-circle fa-lg me-2"></i>
                    <h5 class="modal-title mb-0" id="addFAQModalLabel">Add New FAQ</h5>
                </div>
                <button type="button"
                        class="btn-close btn-close-white"
                        data-bs-dismiss="modal"
                        aria-label="Close">
                </button>
            </div>

            <form id="addFAQForm" method="post" action="{% url 'add_faq' %}" class="needs-validation" novalidate>
                {% csrf_token %}
                <div class="modal-body p-4">
                    <!-- Category Selection -->
                    <div class="form-group mb-4">
                        <label class="form-label d-flex align-items-center">
                            <i class="fas fa-folder text-info me-2"></i>
                            Category
                        </label>
                        <select class="form-select" name="category" required>
                            <option value="">Select a category</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% empty %}
                            <option value="">No categories available</option>
                            {% endfor %}
                        </select>

                        <div class="invalid-feedback">
                            Please select a category.
                        </div>
                    </div>

                    <!-- Question Input -->
                    <div class="form-group mb-4">
                        <label class="form-label d-flex align-items-center" for="newQuestion">
                            <i class="fas fa-question text-info me-2"></i>
                            Question
                        </label>
                        <div class="input-group">
                            <input type="text"
                                   class="form-control"
                                   id="newQuestion"
                                   name="question"
                                   placeholder="Enter your question here"
                                   required>
                            <span class="input-group-text bg-light">
                                <i class="fas fa-pen"></i>
                            </span>
                        </div>
                        <div class="invalid-feedback">
                            Please enter a question.
                        </div>
                        <small class="text-muted mt-1">
                            Write a clear, concise question that users might ask.
                        </small>
                    </div>

                    <!-- Answer Input -->
                    <div class="form-group mb-4">
                        <label class="form-label d-flex align-items-center" for="newAnswer">
                            <i class="fas fa-comment-dots text-info me-2"></i>
                            Answer
                        </label>
                        <div class="input-group">
                            <textarea class="form-control"
                                      id="newAnswer"
                                      name="answer"
                                      rows="6"
                                      placeholder="Enter the answer here"
                                      required></textarea>
                            <span class="input-group-text bg-light">
                                <i class="fas fa-paragraph"></i>
                            </span>
                        </div>
                        <div class="invalid-feedback">
                            Please provide an answer.
                        </div>
                        <small class="text-muted mt-1">
                            Provide a detailed, helpful answer. You can use markdown for formatting.
                        </small>
                    </div>

                    <!-- Tags Input -->
                    <div class="form-group mb-4">
                        <label class="form-label d-flex align-items-center">
                            <i class="fas fa-tags text-info me-2"></i>
                            Tags
                        </label>
                        <input type="text"
                               class="form-control"
                               name="tags"
                               placeholder="Enter tags separated by commas">
                        <small class="text-muted mt-1">
                            Optional: Add relevant tags to help with categorization
                        </small>
                    </div>

                    <!-- Priority Selection -->
                    <div class="form-group">
                        <label class="form-label d-flex align-items-center">
                            <i class="fas fa-flag text-info me-2"></i>
                            Priority
                        </label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="priority" id="priority1" value="low" checked>
                            <label class="btn btn-outline-secondary" for="priority1">Low</label>

                            <input type="radio" class="btn-check" name="priority" id="priority2" value="medium">
                            <label class="btn btn-outline-secondary" for="priority2">Medium</label>

                            <input type="radio" class="btn-check" name="priority" id="priority3" value="high">
                            <label class="btn btn-outline-secondary" for="priority3">High</label>
                        </div>
                    </div>
                </div>

                <div class="modal-footer bg-light">
                    <div class="d-flex justify-content-between w-100">
                        <button type="button"
                                class="btn btn-outline-secondary"
                                data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>
                            Cancel
                        </button>
                        <div class="d-flex gap-2">
                            <button type="button"
                                    class="btn btn-outline-primary"
                                    id="previewBtn">
                                <i class="fas fa-eye me-2"></i>
                                Preview
                            </button>
                            <button type="submit"
                                    class="btn btn-success">
                                <i class="fas fa-save me-2"></i>
                                Add FAQ
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Take note Modal -->
<div class="modal fade" id="addCallNoteModal" tabindex="-1" role="dialog" aria-labelledby="addCallNoteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-gradient bg-warning text-white align-items-center">
                <div class="d-flex align-items-center">
                    <i class="fas fa-phone-alt fa-lg me-2"></i>
                    <h5 class="modal-title mb-0" id="addCallNoteModalLabel">Add Call Note</h5>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form method="POST" action="{% url 'add_call_note' %}" class="needs-validation" novalidate>
                {% csrf_token %}
                <div class="modal-body p-4">
                    <!-- Customer Name -->
                    <div class="form-group mb-4">
                        <label class="form-label d-flex align-items-center">
                            <i class="fas fa-user text-warning me-2"></i>
                            Customer Name
                        </label>
                        <input type="text" class="form-control" name="customer" placeholder="Enter customer name" required>
                        <div class="invalid-feedback">
                            Please enter the customer's name.
                        </div>
                    </div>

                    <!-- Call Type -->
                    <div class="form-group mb-4">
                        <label class="form-label d-flex align-items-center">
                            <i class="fas fa-tag text-warning me-2"></i>
                            Call Type
                        </label>
                        <select class="form-select" name="call_type" required>
                            <option value="">Select call type</option>
                            <option value="general">General Inquiry</option>
                            <option value="support">Technical Support</option>
                            <option value="inquiry">Complaint</option>
                            <option value="followup">Follow-up</option>
                        </select>
                        <div class="invalid-feedback">
                            Please select a call type.
                        </div>
                    </div>

                    <!-- Priority -->
                    <div class="form-group mb-4">
                        <label class="form-label d-flex align-items-center">
                            <i class="fas fa-flag text-warning me-2"></i>
                            Priority
                        </label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="priority" id="priority-low" value="low" checked>
                            <label class="btn btn-outline-secondary" for="priority-low">
                                <i class="fas fa-arrow-down text-success me-1"></i>Low
                            </label>

                            <input type="radio" class="btn-check" name="priority" id="priority-medium" value="medium">
                            <label class="btn btn-outline-secondary" for="priority-medium">
                                <i class="fas fa-minus text-warning me-1"></i>Medium
                            </label>

                            <input type="radio" class="btn-check" name="priority" id="priority-high" value="high">
                            <label class="btn btn-outline-secondary" for="priority-high">
                                <i class="fas fa-arrow-up text-danger me-1"></i>High
                            </label>
                        </div>
                    </div>

                    <!-- Note Content -->
                    <div class="form-group mb-4">
                        <label class="form-label d-flex align-items-center" for="call-note">
                            <i class="fas fa-comment-alt text-warning me-2"></i>
                            Note Details
                        </label>
                        <div class="input-group">
                            <textarea class="form-control"
                                      id="call-note"
                                      name="note"
                                      rows="5"
                                      placeholder="Enter detailed notes about the call..."
                                      required></textarea>
                            <span class="input-group-text bg-light">
                                <i class="fas fa-paragraph"></i>
                            </span>
                        </div>
                        <div class="invalid-feedback">
                            Please enter call notes.
                        </div>
                        <small class="text-muted mt-1">
                            Include key points discussed, actions taken, and any follow-up required.
                        </small>
                    </div>

                    <!-- Follow-up Section -->
                    <div class="form-group mb-4">
                        <label class="form-label d-flex align-items-center">
                            <i class="fas fa-clock text-warning me-2"></i>
                            Follow-up Required
                        </label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="followupRequired" name="followup">
                            <label class="form-check-label" for="followupRequired">Schedule follow-up</label>
                        </div>
                    </div>

                    <!-- Follow-up Date (Initially Hidden) -->
<!--                    <div class="form-group mb-4 d-none" id="followupDateGroup">-->
<!--                        <label class="form-label d-flex align-items-center">-->
<!--                            <i class="fas fa-calendar text-warning me-2"></i>-->
<!--                            Follow-up Date-->
<!--                        </label>-->
<!--                        <input type="datetime-local" class="form-control" name="followup_date">-->
<!--                    </div>-->
<!--                </div>-->

                <div class="modal-footer bg-light">
                    <div class="d-flex justify-content-between w-100">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>Cancel
                        </button>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-primary" id="previewNoteBtn">
                                <i class="fas fa-eye me-2"></i>Preview
                            </button>
                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-save me-2"></i>Save Note
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
</div>

<!-- Respond to Chat Modal -->
<div class="modal fade" id="respondChatModal" tabindex="-1" role="dialog" aria-labelledby="respondChatModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content border-0 shadow">
            <!-- Modal Header -->
            <div class="modal-header bg-gradient bg-primary text-white align-items-center">
                <div class="d-flex align-items-center">
                    <i class="fas fa-reply fa-lg me-2"></i>
                    <h5 class="modal-title mb-0" id="respondChatModalLabel">
                        Respond to <span id="senderName" class="fw-bold"></span>
                    </h5>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form method="POST" action="{% url 'respond_chat' %}" class="needs-validation" novalidate>
                {% csrf_token %}
                <input type="hidden" id="chatId" name="chat_id">

                <!-- Original Message Preview -->
                <div class="original-message bg-light p-3 border-bottom">
                    <small class="text-muted d-block mb-1">Original Message:</small>
                    <div class="original-content" id="originalMessage">
                        <!-- Original message will be inserted here via JavaScript -->
                    </div>
                </div>

                <div class="modal-body p-4">
                    <!-- Response Type Selection -->
                    <div class="form-group mb-4">
                        <label class="form-label d-flex align-items-center">
                            <i class="fas fa-tag text-primary me-2"></i>
                            Response Type
                        </label>
                        <select class="form-select" name="response_type" required>
                            <option value="">Select response type</option>
                            <option value="general">General Response</option>
                            <option value="technical">Technical Support</option>
                            <option value="inquiry">Information Inquiry</option>
                            <option value="urgent">Urgent Matter</option>
                        </select>
                        <div class="invalid-feedback">
                            Please select a response type.
                        </div>
                    </div>

                    <!-- Template Selection -->
                    <div class="form-group mb-4">
                        <label class="form-label d-flex align-items-center">
                            <i class="fas fa-file-alt text-primary me-2"></i>
                            Response Template
                        </label>
                        <select class="form-select" id="templateSelect">
                            <option value="">Choose a template (optional)</option>
                            <option value="greeting">General Greeting</option>
                            <option value="technical">Technical Support</option>
                            <option value="followup">Follow-up Required</option>
                            <option value="urgent">Urgent Response</option>
                        </select>
                    </div>

                    <!-- Response Message -->
                    <div class="form-group mb-4">
                        <label class="form-label d-flex align-items-center" for="responseMessage">
                            <i class="fas fa-comment text-primary me-2"></i>
                            Your Response
                        </label>
                        <div class="input-group">
                            <textarea class="form-control"
                                      id="responseMessage"
                                      name="response"
                                      rows="5"
                                      placeholder="Type your response here..."
                                      required></textarea>
                            <span class="input-group-text bg-light">
                                <i class="fas fa-pen"></i>
                            </span>
                        </div>
                        <div class="invalid-feedback">
                            Please enter your response.
                        </div>
                        <div class="mt-2">
                            <div class="d-flex align-items-center mb-1">
                                <small class="text-muted me-2">Formatting:</small>
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-outline-secondary" onclick="formatText('bold')">
                                        <i class="fas fa-bold"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="formatText('italic')">
                                        <i class="fas fa-italic"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="formatText('list')">
                                        <i class="fas fa-list"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Options -->
                    <div class="form-group">
                        <div class="d-flex flex-wrap gap-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="sendCopy" name="send_copy">
                                <label class="form-check-label" for="sendCopy">
                                    Send me a copy
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="markUrgent" name="mark_urgent">
                                <label class="form-check-label" for="markUrgent">
                                    Mark as urgent
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="requireFollowup" name="require_followup">
                                <label class="form-check-label" for="requireFollowup">
                                    Requires follow-up
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer bg-light">
                    <div class="d-flex justify-content-between w-100">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>Cancel
                        </button>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-primary" id="previewResponseBtn">
                                <i class="fas fa-eye me-2"></i>Preview
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane me-2"></i>Send Response
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Sender Details Modal -->
<div class="modal fade" id="senderDetailsModal" tabindex="-1" role="dialog" aria-labelledby="senderDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-gradient bg-primary text-white">
                <div class="d-flex align-items-center">
                    <i class="fas fa-user-circle fa-lg me-2"></i>
                    <h5 class="modal-title mb-0" id="senderDetailsModalLabel">Customer Profile</h5>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body p-0">
                <div class="row g-0">
                    <!-- Left Column: Customer Details -->
                    <div class="col-md-4 border-end bg-light">
                        <div class="p-4">
                            <!-- Profile Avatar -->
                            <div class="text-center mb-4">
                                <div class="avatar-circle mx-auto mb-3 bg-primary bg-opacity-10 d-flex align-items-center justify-content-center"
                                     style="width: 100px; height: 100px;">
                                    <i class="fas fa-user fa-3x text-primary"></i>
                                </div>
                                <h5 class="mb-0" id="modalSenderName">Loading...</h5>
                                <span class="badge bg-success mt-2">Active Customer</span>
                            </div>

                            <!-- Key Details -->
                            <div class="customer-details">
                                <div class="detail-item mb-3">
                                    <label class="text-muted mb-1">
                                        <i class="fas fa-fingerprint text-primary me-2"></i>Application Type
                                    </label>
                                    <p class="mb-0 fw-bold" id="modalApplicationID">Loading...</p>
                                </div>

                                <div class="detail-item mb-3">
                                    <label class="text-muted mb-1">
                                        <i class="fas fa-calendar text-primary me-2"></i>Application Date
                                    </label>
                                    <p class="mb-0 fw-bold" id="modalApplicationDate">Loading...</p>
                                </div>

                                <div class="detail-item mb-3">
                                    <label class="text-muted mb-1">
                                        <i class="fas fa-map-marker-alt text-primary me-2"></i>Location
                                    </label>
                                    <p class="mb-0 fw-bold" id="modalApplicationLocation">Loading...</p>
                                </div>

                                <div class="detail-item">
                                    <label class="text-muted mb-1">
                                        <i class="fas fa-clock text-primary me-2"></i>Status
                                    </label>
                                    <div class="progress" style="height: 10px;">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: 75%"></div>
                                    </div>
                                    <small  id="applicationProgressText" class="text-muted">Application Progress: 0%</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Notes & Activity -->
                    <div class="col-md-8">
                        <div class="p-4">
                            <!-- Notes Header -->
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h5 class="mb-0">
                                    <i class="fas fa-sticky-note text-primary me-2"></i>Notes & Activity
                                </h5>
                               <div class="btn-group">
                                    <button class="btn btn-outline-primary btn-sm active" data-filter="all">All Notes</button>
                                    <button class="btn btn-outline-primary btn-sm" data-filter="important">Important</button>
                                    <button class="btn btn-outline-primary btn-sm" data-filter="followup">Follow-ups</button>
                                </div>

                            </div>

                            <!-- Notes Container -->
                            <div id="notesContainer" class="notes-container mb-4" style="max-height: 300px; overflow-y: auto;">
                                <div class="placeholder-content text-center py-4">
                                    <i class="fas fa-notebook fa-3x text-muted mb-3"></i>
                                    <p class="text-muted mb-0">No notes available</p>
                                </div>
                            </div>

                            <!-- Add Note Form -->
                            <div class="add-note-form bg-light p-3 rounded-3">
                                <h6 class="mb-3">
                                    <i class="fas fa-plus-circle text-primary me-2"></i>Add New Note
                                </h6>
                                <div class="mb-3">
                                    <select id="noteTitle" class="form-select form-select-sm mb-3">
                                        <option value="general">General Note</option>
                                        <option value="important">Important</option>
                                        <option value="followup">Follow-up Required</option>
                                    </select>
                                    <textarea id="noteText"
                                              class="form-control"
                                              rows="3"
                                              placeholder="Enter your note here..."></textarea>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="markImportant">
                                        <label class="form-check-label" for="markImportant">
                                            Mark as important
                                        </label>
                                    </div>
                                    <button id="saveNoteBtn" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>Save Note
                                    </button>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Update FAQ Modal -->
<div class="modal fade" id="updateFAQModal" tabindex="-1" aria-labelledby="updateFAQModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow">
            <!-- Modal Header -->
            <div class="modal-header bg-gradient bg-warning text-white align-items-center">
                <div class="d-flex align-items-center">
                    <i class="fas fa-edit fa-lg me-2"></i>
                    <h5 class="modal-title mb-0" id="updateFAQModalLabel">Edit FAQ Entry</h5>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body p-4">
                <div class="row">
                    <!-- Left Section: Edit Form -->
                    <div class="col-md-8">
                        <form id="updateFAQForm" method="post" class="needs-validation" novalidate>
                            {% csrf_token %}
                            <input type="hidden" id="faqId" name="faq_id">

                            <!-- Category Selection -->
                            <div class="mb-4">
                                <label for="editCategory" class="form-label d-flex align-items-center">
                                    <i class="fas fa-folder text-warning me-2"></i>
                                    Category
                                </label>
                                <select class="form-select" id="editCategory" name="category" required>
                                    <option value="">Select category</option>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}" {% if category.id == faq.category.id %}selected{% endif %}>
                                        {{ category.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback">
                                    Please select a category.
                                </div>
                            </div>

                            <!-- Question Input -->
                            <div class="mb-4">
                                <label for="editQuestion" class="form-label d-flex align-items-center">
                                    <i class="fas fa-question-circle text-warning me-2"></i>
                                    Question
                                </label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="editQuestion" name="question" required>
                                    <span class="input-group-text bg-light"><i class="fas fa-pen"></i></span>
                                    <div class="invalid-feedback">
                                        Please enter a question.
                                    </div>
                                </div>
                            </div>

                            <!-- Answer Input -->
                            <div class="mb-4">
                                <label for="editAnswer" class="form-label d-flex align-items-center">
                                    <i class="fas fa-comment-dots text-warning me-2"></i>
                                    Answer
                                </label>
                                <textarea class="form-control" id="editAnswer" name="answer" rows="8" required></textarea>
                                <div class="invalid-feedback">
                                    Please provide an answer.
                                </div>
                                <small class="text-muted">You can use Markdown formatting for better text organization.</small>
                            </div>

                            <!-- Tags Input -->
                            <div class="mb-4">
                                <label for="editTags" class="form-label d-flex align-items-center">
                                    <i class="fas fa-tags text-warning me-2"></i>
                                    Tags
                                </label>
                                <input type="text" class="form-control" id="editTags" name="tags" placeholder="Enter tags separated by commas">
                                <small class="text-muted">Optional: Add relevant tags to help with searching.</small>
                            </div>
                        </form>
                    </div>

                    <!-- Right Section: FAQ Info -->
                    <div class="col-md-4">
                        <div class="bg-light p-3 rounded-3">
                            <h6 class="mb-3">
                                <i class="fas fa-info-circle text-warning me-2"></i>
                                FAQ Information
                            </h6>
                            <div class="mb-3">
                                <small class="text-muted d-block">Last Updated</small>
                                <span class="text-dark" id="lastUpdated"></span>
                            </div>
                            <div class="mb-3">
                                <small class="text-muted d-block">Created by</small>
                                <span class="text-dark" id="createdBy"></span>
                            </div>
                            <div class="mb-3">
                                <small class="text-muted d-block">View Count</small>
                                <span class="text-dark" id="viewCount"></span>
                            </div>
                            <hr>
                            <h6 class="mb-3">
                                <i class="fas fa-lightbulb text-warning me-2"></i>
                                Tips
                            </h6>
                            <ul class="list-unstyled small">
                                <li class="mb-2">
                                    <i class="fas fa-check text-success me-2"></i>
                                    Keep answers clear and concise.
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check text-success me-2"></i>
                                    Use formatting for better readability.
                                </li>
                                <li>
                                    <i class="fas fa-check text-success me-2"></i>
                                    Include relevant examples when possible.
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="submit" form="updateFAQForm" class="btn btn-warning">
                    <i class="fas fa-save me-2"></i>Update FAQ
                </button>
            </div>
        </div>
    </div>
</div>




<script>
    // Handle Respond button click
    document.addEventListener('DOMContentLoaded', function () {
        const respondButtons = document.querySelectorAll('.respond-btn');
        const chatIdInput = document.getElementById('chatId');
        const senderNameSpan = document.getElementById('senderName');

        respondButtons.forEach(button => {
            button.addEventListener('click', function () {
                const chatId = button.getAttribute('data-chat-id');
                const senderName = button.getAttribute('data-sender-name');

                chatIdInput.value = chatId;
                senderNameSpan.textContent = senderName;
            });
        });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const closeButtons = document.querySelectorAll('.close-btn');

        closeButtons.forEach(button => {
            button.addEventListener('click', function () {
                const chatId = button.getAttribute('data-chat-id');
                fetch("{% url 'close_chat' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `chat_id=${chatId}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove the chat item from the list
                        const chatItem = document.getElementById(`chat-${chatId}`);
                        if (chatItem) {
                            chatItem.remove();
                        }
                    } else {
                        console.error('Error:', data.error);
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        });
    });
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    let senderId = null;
    let chatId = null;
    const currentUserName = "{{ request.user.get_full_name }}"; // Pass current user name dynamically

    // Sender details click event to load sender info and notes
    $('.sender-details-link').on('click', function () {
        senderId = $(this).data('sender-id');
        chatId = $(this).data('chat-id');
        const senderName = $(this).data('sender-name');

        // Set sender name in the modal
        $('#modalSenderName').text(senderName);

        // Clear previous data
        $('#modalApplicationID').text('Loading...');
        $('#modalApplicationDate').text('Loading...');
        $('#modalApplicationLocation').text('Loading...');
        $('#noteText').val('');
        $('#notesContainer').html('<p class="text-muted">Loading notes...</p>');
        $('.progress-bar').css('width', '0%'); // Reset progress bar
        $('#applicationProgressText').text('Application Progress: 0%');

        // Fetch application details via AJAX
        $.ajax({
            url: `/immigration/get_user_application/${senderId}/`,
            method: 'GET',
            success: function (data) {
                if (data.success) {
                    $('#modalApplicationID').text(data.application_id);
                    $('#modalApplicationDate').text(data.application_date);
                    $('#modalApplicationLocation').text(data.application_location);

                    // Update the progress bar and text dynamically
                    const progressPercentage = data.progress || 0; // Default to 0 if no progress value is provided
                    $('.progress-bar').css('width', progressPercentage + '%');
                    $('#applicationProgressText').text(`Application Progress: ${progressPercentage}%`);
                } else {
                    $('#modalApplicationID').text('No application found');
                    $('#modalApplicationDate').text('-');
                    $('#modalApplicationLocation').text('-');
                }
            },
            error: function () {
                $('#modalApplicationID').text('Error fetching data');
                $('#modalApplicationDate').text('-');
                $('#modalApplicationLocation').text('-');
                $('.progress-bar').css('width', '0%');
                $('#applicationProgressText').text('Application Progress: 0%');
            }
        });

        // Fetch user notes via AJAX
        $.ajax({
            url: `/immigration/get_user_notes/${senderId}/`,
            method: 'GET',
            success: function (data) {
                if (data.notes.length > 0) {
                    let notesHtml = '';
                    data.notes.forEach(note => {
                        // Add color based on the importance
                        const importantClass = note.important ? 'important' : '';
                        const noteTitleColor = note.important ? 'badge-danger' : 'badge-secondary';

                        notesHtml += `
                            <div class="note-item ${note.title}" data-title="${note.title.toLowerCase()}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <p><strong>${note.created_by} ${note.title}</strong>: ${note.note}</p>
                                        <small class="text-muted">${note.created_at}</small>
                                    </div>
                                    <span class="badge ${noteTitleColor}">${note.title.toUpperCase()}</span>
                                </div>
                            </div>
                        `;
                    });
                    $('#notesContainer').html(notesHtml);
                } else {
                    $('#notesContainer').html('<p class="text-muted">No notes available.</p>');
                }
            },
            error: function () {
                $('#notesContainer').html('<p class="text-danger">Error fetching notes.</p>');
            }
        });
    });

    // Save note functionality via AJAX and display immediately
    $('#saveNoteBtn').on('click', function () {
        const noteText = $('#noteText').val().trim();
        const noteTitle = $('#noteTitle').val(); // Get selected note title (General, Important, Follow-up)
        const isImportant = $('#markImportant').prop('checked'); // Check if "Important" checkbox is ticked

        if (!noteText || !noteTitle) {
            alert('Please enter both a title and a note before saving.');
            return;
        }

        $.ajax({
            url: '/immigration/save_note/',
            method: 'POST',
            data: {
                'sender_id': senderId,
                'chat_id': chatId,
                'note': noteText,
                'title': noteTitle, // Include title field (General, Important, Follow-up)
                'important': isImportant ? 1 : 0, // Include the "important" flag based on checkbox state
                'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val() // CSRF token
            },
            success: function (data) {
                if (data.success) {
                    // Add color based on importance
                    const importantClass = isImportant ? 'important' : '';
                    const noteTitleColor = isImportant ? 'badge-danger' : 'badge-secondary';

                    const newNoteHtml = `
                        <div class="note-item ${importantClass}" data-title="${noteTitle.toLowerCase()}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <p><strong>${currentUserName}</strong>: <strong>${noteTitle}</strong> - ${noteText}</p>
                                    <small class="text-muted">${new Date().toLocaleString()}</small>
                                </div>
                                <span class="badge ${noteTitleColor}">${noteTitle}</span>
                            </div>
                        </div>
                    `;
                    $('#notesContainer').prepend(newNoteHtml); // Prepend the new note to the notes container
                    $('#noteText').val(''); // Clear the text area
                    $('#noteTitle').val('general'); // Reset the title dropdown to default value
                    $('#markImportant').prop('checked', false); // Reset the "important" checkbox
                    alert('Note saved successfully.');
                } else {
                    alert('Failed to save note: ' + data.error);
                }
            },
            error: function () {
                alert('An error occurred while saving the note.');
            }
        });
    });

    // Note type toggle functionality
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Remove active class from all buttons
            document.querySelectorAll('.btn-group .btn').forEach(b => b.classList.remove('active'));
            // Add active class to clicked button
            this.classList.add('active');

            // Filter notes based on the active button (General, Important, Follow-ups)
            const filterType = this.textContent.trim().toLowerCase(); // General, Important, Follow-ups
            filterNotes(filterType);
        });
    });

    // Filter notes based on type
    function filterNotes(type) {
        const notesContainer = document.getElementById('notesContainer');
        const notes = notesContainer.querySelectorAll('.note-item');

        // Loop through all notes and toggle visibility based on the selected type
        notes.forEach(note => {
            const noteType = note.dataset.title; // Get the data-title attribute for each note

            // Display notes based on the selected filter type
            if (type === 'all' || noteType === type) {
                note.style.display = ''; // Show note
            } else {
                note.style.display = 'none'; // Hide note
            }
        });
    }

    // Initialize the default filter (show all notes)
    filterNotes('all');
});
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const closeNoteButtons = document.querySelectorAll('.close-note-btn');

        closeNoteButtons.forEach(button => {
            button.addEventListener('click', function () {
                const noteId = this.dataset.noteId;
                const noteItem = this.closest('.list-group-item');
                const noteText = noteItem.querySelector('.note-text');
                const buttonIcon = this.querySelector('i');

                // Confirm before marking as completed
                if (!confirm('Are you sure you want to close this note?')) {
                    return;
                }

                // Send AJAX request to mark note as completed
                fetch(`/immigration/close_call_note/${noteId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update UI to reflect completed note
                        noteText.classList.add('completed');
                        this.classList.remove('btn-danger');
                        this.classList.add('btn-success');
                        buttonIcon.classList.remove('fa-times-circle');
                        buttonIcon.classList.add('fa-check-circle');
                        this.disabled = true;
                    } else {
                        alert('Failed to close the note: ' + data.error);
                    }
                })
                .catch(() => {
                    alert('An error occurred while closing the note.');
                });
            });
        });
    });
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('searchCallNotes');
    const callNotesContainer = document.getElementById('callNotesContainer');

    // Function to handle marking a note as completed
    function attachCloseNoteHandlers() {
        document.querySelectorAll('.close-note-btn').forEach(button => {
            button.addEventListener('click', function () {
                const noteId = this.dataset.noteId;

                if (!noteId) {
                    alert('Invalid note ID.');
                    return;
                }

                if (confirm('Are you sure you want to close this note?')) {
                    fetch(`/immigration/close_call_note/${noteId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/json'
                        },
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const noteElement = document.getElementById(`note-${noteId}`);
                            const noteText = noteElement.querySelector('.note-content');
                            noteText.classList.add('text-muted');
                            this.classList.replace('btn-outline-success', 'btn-success');
                            this.innerHTML = '<i class="fas fa-check-circle"></i>';
                            this.disabled = true;
                        } else {
                            alert('Failed to close note: ' + data.error);
                        }
                    })
                    .catch(() => {
                        alert('An error occurred while closing the note.');
                    });
                }
            });
        });
    }

    // Search functionality
    searchInput.addEventListener('keyup', function () {
        const query = searchInput.value.trim();

        fetch(`/immigration/search_call_notes/?q=${query}`)
            .then(response => response.json())
            .then(data => {
                if (data.notes.length > 0) {
                    let notesHtml = '';
                    data.notes.forEach(note => {
                        notesHtml += `
                            <div class="timeline-item mb-4 ${note.completed ? 'completed' : ''}" id="note-${note.id}">
                                <div class="timeline-badge ${note.completed ? 'bg-success' : 'bg-warning'}">
                                    <i class="fas ${note.completed ? 'fa-check' : 'fa-phone'}"></i>
                                </div>
                                <div class="timeline-content">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-body">
                                            <!-- Note Header -->
                                            <div class="d-flex justify-content-between align-items-start mb-3">
                                                <div class="d-flex align-items-center">
                                                    <div class="avatar-circle bg-light rounded-circle d-flex align-items-center justify-content-center me-2"
                                                         style="width: 40px; height: 40px;">
                                                        <i class="fas fa-user text-warning"></i>
                                                    </div>
                                                    <div>
                                                        <h6 class="mb-0 font-weight-bold" style="text-transform: uppercase;">${note.customer}</h6>
                                                        <small class="text-muted">
                                                            <i class="fas fa-clock me-1"></i>
                                                            ${note.created_at}
                                                        </small>
                                                    </div>
                                                </div>
                                                <div class="d-flex gap-2">
                                                    <button class="btn btn-outline-primary btn-sm">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-sm ${note.completed ? 'btn-success disabled' : 'btn-outline-success'} close-note-btn"
                                                            data-note-id="${note.id}">
                                                        <i class="fas ${note.completed ? 'fa-check-circle' : 'fa-check'}"></i>
                                                    </button>
                                                </div>
                                            </div>

                                            <!-- Note Content -->
                                            <div class="note-content ${note.completed ? 'text-muted' : ''}">
                                                <div class="p-3 bg-light rounded-3 ${note.completed ? 'bg-opacity-50' : ''}">
                                                    ${note.note}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    callNotesContainer.innerHTML = notesHtml;
                    attachCloseNoteHandlers(); // Reattach event handlers after updating the list
                } else {
                    callNotesContainer.innerHTML = `
                        <div class="text-center py-5">
                            <div class="mb-3">
                                <i class="fas fa-sticky-note fa-3x text-muted"></i>
                            </div>
                            <h6 class="text-muted">No call notes found</h6>
                            <p class="text-muted small mb-0">Try adjusting your search query.</p>
                        </div>
                    `;
                }
            })
            .catch(() => {
                callNotesContainer.innerHTML = `
                    <div class="text-danger text-center py-5">
                        <p><i class="fas fa-exclamation-circle"></i> Error fetching call notes.</p>
                    </div>
                `;
            });
    });

    // Attach close note handlers on initial load
    attachCloseNoteHandlers();
});
</script>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('searchFAQ');
        const faqContainer = document.getElementById('faqContainer');

        searchInput.addEventListener('keyup', function () {
            const query = searchInput.value.trim();

            fetch(`/immigration/search_faqs/?q=${query}`)
                .then(response => response.json())
                .then(data => {
                    if (data.faqs.length > 0) {
                        let faqHtml = '<ul class="list-group">';
                        data.faqs.forEach(faq => {
                            faqHtml += `
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>${faq.question}</strong><br>
                                        <p class="mb-0">${faq.answer}</p>
                                    </div>
                                    <div class="btn-group">
                                        <button class="btn btn-warning btn-sm edit-faq-btn"
                                                data-toggle="modal"
                                                data-target="#updateFAQModal"
                                                data-faq-id="${faq.id}"
                                                data-question="${faq.question}"
                                                data-answer="${faq.answer}">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                        <a href="/immigration/delete_faq/${faq.id}/" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this FAQ?');">
                                            <i class="fas fa-trash-alt"></i> Delete
                                        </a>
                                    </div>
                                </li>
                            `;
                        });
                        faqHtml += '</ul>';
                        faqContainer.innerHTML = faqHtml;
                    } else {
                        faqContainer.innerHTML = '<p class="text-muted text-center">No FAQs found.</p>';
                    }
                })
                .catch(() => {
                    faqContainer.innerHTML = '<p class="text-danger text-center">Error fetching FAQs.</p>';
                });
        });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Populate the update modal with FAQ data
        document.querySelectorAll('.edit-faq-btn').forEach(button => {
            button.addEventListener('click', function () {
                const faqId = this.getAttribute('data-faq-id');
                const question = this.getAttribute('data-question');
                const answer = this.getAttribute('data-answer');
                const createdBy = this.getAttribute('data-created-by');
                const updatedAt = this.getAttribute('data-updated-at');
                const tags = this.getAttribute('data-tags') || ''; // Fallback if tags are empty
                const priority = this.getAttribute('data-priority') || 'medium'; // Default to 'medium'
                const viewCount = this.getAttribute('data-view-count') || 0; // Default to 0

                // Set the values in the modal form fields
                document.getElementById('faqId').value = faqId;
                document.getElementById('editQuestion').value = question;
                document.getElementById('editAnswer').value = answer;
                document.getElementById('editTags').value = tags;
                document.getElementById('editPriority').value = priority;
                document.getElementById('lastUpdated').value = updatedAt;
                document.getElementById('createdBy').value = createdBy;

                // Set the view count (could be used to show stats)
                document.getElementById('viewCount').innerText = `Views: ${viewCount}`;
            });
        });

        // Handle the form submission via AJAX
        document.getElementById('updateFAQForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const faqId = formData.get('faq_id');

            // Add the current logged-in user to the form data
            formData.append('updated_by', '{{ request.user.id }}');  // Pass logged-in user ID

            fetch(`/immigration/update_faq/${faqId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('FAQ updated successfully!');
                    location.reload();  // Reload to reflect updates
                } else {
                    alert('Failed to update FAQ: ' + data.error);
                }
            })
            .catch(() => {
                alert('An error occurred while updating the FAQ.');
            });
        });
    });
</script>




<script>
    // Function to animate numbers
    function animateCountUp(targetElement, start, end, duration) {
        const increment = Math.ceil((end - start) / (duration / 10)); // Define step increment
        let current = start;

        const counter = setInterval(() => {
            current += increment;
            if (current >= end) {
                current = end;
                clearInterval(counter);
            }
            targetElement.textContent = current; // Update the number in the element
        }, 10); // Refresh every 10ms for smooth animation
    }

    // On window load, start animation for each counter
    window.onload = function () {
        animateCountUp(document.getElementById("open-applications"), 0, {{ open_applications }}, 1000); // 1 sec duration
        animateCountUp(document.getElementById("closed-applications"), 0, {{ closed_applications }}, 1000);
        animateCountUp(document.getElementById("open-chats"), 0, {{ open_chats }}, 1000);
        animateCountUp(document.getElementById("closed-chats"), 0, {{ closed_chats }}, 1000);
    };
</script>


<script>
    document.querySelectorAll('.btn-danger').forEach(button => {
        button.addEventListener('click', function (e) {
            if (!confirm('Are you sure you want to delete this FAQ?')) {
                e.preventDefault();
            }
        });
    });
</script>
<script>
// Form validation
document.getElementById('addFAQForm').addEventListener('submit', function(event) {
    if (!this.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
    }
    this.classList.add('was-validated');
});

// Preview functionality
document.getElementById('previewBtn').addEventListener('click', function() {
    const question = document.getElementById('newQuestion').value;
    const answer = document.getElementById('newAnswer').value;
    // Implement preview logic here
});
</script>

<script>
// Form validation
document.getElementById('addCallNoteModal').addEventListener('submit', function(event) {
    if (!this.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
    }
    this.classList.add('was-validated');
});

// Toggle follow-up date field
document.getElementById('followupRequired').addEventListener('change', function() {
    const followupDateGroup = document.getElementById('followupDateGroup');
    followupDateGroup.classList.toggle('d-none');
    if (!this.checked) {
        followupDateGroup.querySelector('input').value = '';
    }
});

// Preview functionality
document.getElementById('previewNoteBtn').addEventListener('click', function() {
    const note = document.getElementById('call-note').value;
    // Implement preview logic here
});
</script>
<script>
// Form validation
document.getElementById('respondChatModal').addEventListener('submit', function(event) {
    if (!this.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
    }
    this.classList.add('was-validated');
});

// Template handling
document.getElementById('templateSelect').addEventListener('change', function() {
    const templates = {
        greeting: "Hello [Name],\n\nThank you for reaching out. I hope you're having a great day.",
        technical: "Hello [Name],\n\nI understand you're experiencing technical difficulties. Let me help you with that.",
        followup: "Hello [Name],\n\nI'm following up on your previous inquiry regarding [topic].",
        urgent: "Hello [Name],\n\nI understand this is an urgent matter. I'll prioritize this for immediate attention."
    };

    const selectedTemplate = templates[this.value];
    if (selectedTemplate) {
        const responseMessage = document.getElementById('responseMessage');
        responseMessage.value = selectedTemplate.replace('[Name]', document.getElementById('senderName').textContent);
    }
});

// Text formatting
function formatText(type) {
    const textarea = document.getElementById('responseMessage');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);

    let formattedText = '';
    switch(type) {
        case 'bold':
            formattedText = `**${selectedText}**`;
            break;
        case 'italic':
            formattedText = `*${selectedText}*`;
            break;
        case 'list':
            formattedText = `\n- ${selectedText}`;
            break;
    }

    textarea.value = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end);
    textarea.focus();
}

// Preview functionality
document.getElementById('previewResponseBtn').addEventListener('click', function() {
    const response = document.getElementById('responseMessage').value;
    // Implement preview logic here
});
</script>
<script>
// Form validation
document.getElementById('updateFAQForm').addEventListener('submit', function(event) {
    if (!this.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
    }
    this.classList.add('was-validated');
});

// Text formatting functions
function formatText(type) {
    const textarea = document.getElementById('editAnswer');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);

    let formattedText = '';
    switch(type) {
        case 'bold':
            formattedText = `**${selectedText}**`;
            break;
        case 'italic':
            formattedText = `*${selectedText}*`;
            break;
        case 'link':
            formattedText = `[${selectedText}](url)`;
            break;
        case 'list':
            formattedText = `\n- ${selectedText}`;
            break;
        case 'code':
            formattedText = `\`${selectedText}\``;
            break;
    }

    textarea.value = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end);
    textarea.focus();
}

// Preview functionality
document.getElementById('previewBtn').addEventListener('click', function() {
    const question = document.getElementById('editQuestion').value;
    const answer = document.getElementById('editAnswer').value;
    // Implement preview logic here
});
</script>

{% endblock %}