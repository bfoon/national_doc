{% extends 'docs/header.html' %}
{% block content %}

<style>
:root {
    --primary-color: #4f46e5;
    --primary-hover: #4338ca;
    --success-color: #10b981;
    --danger-color: #ef4444;
    --text-primary: #1f2937;
    --text-secondary: #6b7280;
    --bg-gray: #f3f4f6;
}

/* Modern Card Styling */
.card {
    background: white;
    border: none;
    box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
    border-radius: 1rem;
    padding-top: 85px;
    margin-bottom: 2rem;
    position: relative;
    transition: all 0.3s ease;
}

.card:hover {
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
}

/* Enhanced Passport Photo */
.passport-photo-container {
    position: absolute;
    top: 0.5px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
}

.passport-photo {
    width: 90px;
    height: 90px;
    object-fit: cover;
    border: 4px solid white;
    border-radius: 50%;
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    transition: transform 0.3s ease;
}

.passport-photo:hover {
    transform: scale(1.05);
}

/* Modern Card Header */
.card-header {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
    color: white;
    border-radius: 1rem 1rem 0 0;
    padding: 1.25rem;
    border: none;
}

/* Improved Breadcrumb */
.breadcrumb {
    background-color: transparent;
    padding: 1rem 0;
    margin-bottom: 2rem;
}

.breadcrumb-item a {
    color: var(--primary-color);
    text-decoration: none;
    transition: color 0.3s ease;
}

.breadcrumb-item a:hover {
    color: var(--primary-hover);
}

/* Enhanced Form Elements */
.form-control {
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 0.75rem;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

.form-control:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}

.form-control:disabled {
    background-color: var(--bg-gray);
    cursor: not-allowed;
}

/* Modern Signature */
.signature {
    font-family: 'Pacifico', cursive;
    font-size: 1.1rem;
    color: var(--text-primary);
    text-align: right;
    margin-top: 1rem;
    opacity: 0.8;
}

/* Enhanced Badges */
.badge-app {
    padding: 0.5rem 1rem;
    border-radius: 9999px;
    font-weight: 500;
    font-size: 0.875rem;
}

.badge-success {
    background-color: var(--success-color);
    color: white;
}

.badge-danger {
    background-color: var(--danger-color);
    color: white;
}

.badge-warning {
    background-color: #f59e0b;
    color: white;
}

/* Improved Buttons */
.btn {
    padding: 0.625rem 1.25rem;
    border-radius: 0.5rem;
    font-weight: 500;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-success {
    background-color: var(--success-color);
    border-color: var(--success-color);
}

.btn-danger {
    background-color: var(--danger-color);
    border-color: var(--danger-color);
}

.btn-success:hover, .btn-danger:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
}

/* Enhanced Modal */
.modal-content {
    border: none;
    border-radius: 1rem;
    box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
}

.modal-header {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
    color: white;
    border-radius: 1rem 1rem 0 0;
    padding: 1.5rem;
}

.modal-body {
    padding: 1.5rem;
}

.modal-footer {
    border-top: 1px solid #e5e7eb;
    padding: 1.25rem;
}

/* Enhanced Alert */
.alert-danger {
    background-color: #fef2f2;
    border: 1px solid #fee2e2;
    color: #991b1b;
    border-radius: 0.75rem;
    padding: 1rem;
}

/* Responsive Design Improvements */
@media (max-width: 768px) {
    .card {
        margin: 1rem;
        padding-top: 70px;
    }

    .passport-photo {
        width: 80px;
        height: 80px;
    }

    .btn {
        width: 100%;
        margin-bottom: 0.5rem;
    }
}
</style>

<!-- Link to Google Fonts for the signature font -->
<link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">

<div class="container my-5">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'immigration_dashboard' %}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{% url 'todo_list' %}">ToDo List</a></li>
            <li class="breadcrumb-item active">ToDo Details</li>
        </ol>
    </nav>

    <h2 class="text-2xl font-bold text-center mb-6">ToDo Details</h2>

<div class="card shadow mb-4 position-relative">
    <!-- Circular Passport Photo -->
    <div class="passport-photo-container">
        {% if todo.application.national_id_applications.first %}
            <img src="{{ todo.application.national_id_applications.first.passport_photo.url }}" alt="Passport Photo" class="passport-photo">
        {% elif todo.application.resident_permit_applications.first %}
            <img src="{{ todo.application.resident_permit_applications.first.passport_photo.url }}" alt="Passport Photo" class="passport-photo">
        {% elif todo.application.work_permit_applications.first %}
            <img src="{{ todo.application.work_permit_applications.first.passport_photo.url }}" alt="Passport Photo" class="passport-photo">
        {% endif %}
    </div>

    <div class="card-header text-center">
        <h5 class="mb-0">Details for ToDo #{{ todo.id }}</h5>
    </div>

    <div class="card-body">
        <p><strong>Application:</strong> {{ todo.application.get_service_type }}</p>
        <p><strong>Interviewee:</strong> {{ todo.interview.application.user.get_full_name }}</p>
        <p><strong>Interviewer:</strong> {{ todo.user.get_full_name }}</p>
        <p><strong>Interview Duration:</strong> {{ todo.interview.duration }} Min</p>

        <!-- Notes as a read-only textarea -->
        <div class="form-group">
            <label for="notes"><strong>Notes:</strong></label>
            <textarea id="notes" class="form-control" rows="5" readonly>{{ todo.interview.notes }}</textarea>
            <div class="signature">{{ todo.user.get_full_name }}</div>
        </div>

        <p><strong>Approver:</strong>
            {% if todo.approver %}
                {{ todo.approver.get_full_name }}
            {% else %}
                N/A
            {% endif %}
        </p>
        <p><strong>Status:</strong>
            {% if todo.status == 1 %}
                <span class="badge badge-app badge-success">Approved</span>
            {% elif todo.status == 2 %}
                <span class="badge badge-app badge-danger">Rejected</span>
            {% else %}
                <span class="badge badge-app badge-warning">Pending</span>
            {% endif %}
        </p>

        {% if todo.status == 2 %}
            <div class="alert alert-danger mt-3">
                <strong>Rejection Reason:</strong>
                <p>{{ todo.rejection_reason }}</p>
            </div>
        {% endif %}

        {% if todo.status == 0 %}
            <div class="d-flex mt-3">
                <button type="button" class="btn btn-success mr-2" data-toggle="modal" data-target="#approveModal">
                    <i class="fas fa-check"></i> Approve
                </button>
                <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#rejectModal">
                    <i class="fas fa-times"></i> Reject
                </button>
            </div>
        {% endif %}

        {% if todo.status == 1 %}
            <!-- Print Receipt Button -->
            <a href="{% url 'todo_receipt_pdf' todo.id %}" class="btn btn-info float-right">
                <i class="fas fa-print"></i> Print Receipt
            </a>
        {% endif %}
    </div>
</div>

<a href="{% url 'todo_list' %}" class="btn btn-secondary">Back to ToDo List</a>


<!-- Approve Modal -->
<div class="modal fade" id="approveModal" tabindex="-1" role="dialog" aria-labelledby="approveModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="approveModalLabel">Approval Confirmation</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>I, <strong>{{ user.get_full_name }}</strong>, affirm that all documents and interview notes have been reviewed and verified.</p>
                <p>This action is irreversible. Do you confirm approval?</p>
            </div>
            <div class="modal-footer">
                <form method="POST" action="{% url 'approve_todo' todo.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success">Confirm Approval</button>
                </form>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" role="dialog" aria-labelledby="rejectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rejectModalLabel">Reject ToDo Item</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form method="POST" action="{% url 'reject_todo' todo.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="form-group">
                        <label for="rejection_reason">Rejection Reason</label>
                        <textarea class="form-control" id="rejection_reason" name="rejection_reason" rows="5" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-danger">Reject ToDo</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.getElementById('confirmPrint').addEventListener('click', function() {
        window.print();
    });
</script>

{% endblock %}
